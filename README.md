# Тестовое задание на позицию Middle/Senior Php Developer


## Вводная часть

<p>Целью, настоящего тестового задания, является проверка вашей степени владения Symfony и навыков проектирования приложений.</p>  
<p>В рамках, поставленной задачи не оцениваются ваши навыки верстки или знания js-фреймворков, поэтому все приведенные ниже картинки описывают только желательную структуру фронтэнда и если итоговый внешний вид решения будет отличаться от картинок, то ничего страшного - главное реализованный функционал, чистота кода и архитектура приложения.</p>  

### Что предлагается сделать
<p>В качестве тестового задания предлагается реализовать примитивнейшее приложение позволяющее совершить покупку в импровизированном интернет-магазине.</p>

![scheme.png](https://github.com/vladpopov99/test-case/blob/master/.docker/img/scheme.png)

### Критерии успешного выполнения:

- Логика приложения работает корректно от главной и до страницы успешной покупки;
- Отсутствуют прямые обращения к базе данных - все взаимодействие происходит через ORM (допускает использование queryBuilder);
- Реализовано кэширование всех запросов к БД и внешнему апи
- Взаимодействие с сервис-контейнером stubs (эмулирующем обращения к внешним сервисам доставки) организовано через компоненты-клиенты (services.yaml);
- Кастомные компоненты покрыты phpunit-тестами


## Начальная структура базы данных:

<p>products - таблица содержит данные о продуктах;</p>
<p>carts - таблица содержит информацию о корзинах пользователей <b>(у каждого пользователя может быть несколько корзин, однако активная только созданная последней)</b></p>
<p>delivery_service - таблица содержит данные о зарегистрированных, в системе, службах доставки;</p>
<p>payment_services - таблица содержит данные о платежных системах поддерживаемых в приложении</p>

<br />

## Компоненты которые следует реализовать:
### Главная страница

URL: /

![mainpage_unauth.png](https://github.com/vladpopov99/test-case/blob/master/.docker/img/mainpage_unauth.png)

![mainpage_auth.png](https://github.com/vladpopov99/test-case/blob/master/.docker/img/mainpage_auth.png)

<p>
Эта страница должна содержать информацию о доступных товарах и предоставлять возможность перехода на страницу авторизации/регистрации или на страницу корзины, в зависимости от авторизации пользователя.<p>

<p>Основные элементы страницы, которые следует реализовать:</p>

1. Шапка: 

<p><b><u>Если пользователь не авторизован:</u></b> отобразить ссылку на страницу авторизации/регистрации.</p>
<p><b>Если пользователь авторизован:</b> отобразить ссылку на корзину (вместе с общей стоимостью добавленных товаров) вместо ссылки на авторизацию.<p>
2. Превью товаров: 
   Каждая карточка товара должна содержать:
<ul>
<li>Название продукта</li>
<li>Изображение товара</li>
<li>Цена товара</li>
<li>Кнопка для добавления товара в корзину (можно использовать синхронный POST-запрос, реализация на AJAX не обязательна).</li>
</ul>

> [!WARNING]
> Кнопка добавления товара в корзину, должна быть видима только для авторизованного пользователя (ROLE_USER), в ином случае она должна быть скрыта.

<br />

### Страница авторизации/регистрации

URL: /login

<p>Для создания функционала страницы используйте стандартный компонент symfony/security-bundle </p>
<p>Внешний вид страницы может быть абсолютно произвольный - главное чтобы пользователь мог регистрироваться и авторизовываться (допустимо чтобы было две раздельные страницы)</p> 

<br />

### Страница корзины

URL: /checkout/

> [!CAUTION]
> данная страница должна быть закрыта файерволом и недоступна для неавторизованного пользователя

> [!CAUTION]
> при заходе не авторизованного пользователя должен происходить редирект на главную страницу

![cart.png](https://github.com/vladpopov99/test-case/blob/master/.docker/img/cart.png)

<p>На странице корзины, вам необходимо вывести список ранее добавленных в корзину товаров.</p> 
<p>Каждый элемент списка содержит:<p> 
<ul>
<li>изображение продукта</li> 
<li>название</li> 
<li>цена</li> 
<li>добавленное количество</li> 
<li>кнопка удаления товара из корзины.</li> 
</ul>

> [!WARNING]
> Важная деталь: у пользователя может быть множество ранее созданных корзин, однако, текущей корзиной пользователя должна являться. та корзина, которая была создана последней и не имеет статус "оплачена"

<br />

### Страница выбора доставки

URL: /checkout/delivery/

> [!CAUTION]
> данная страница должна быть закрыта файерволом и недоступна для неавторизованного пользователя

> [!CAUTION]
> при заходе неавторизованного пользователя должен происходить редирект на главную страницу

> [!WARNING]
> не должно быть возможности напрямую зайти на эту страницу минуя страницу корзины. поэтому, в случае, если пользователь заходит по прямой ссылке то должен сработать редирект на страницу "корзина". Подсказка: проверяйте заголовки refferer

<img src="https://github.com/vladpopov99/test-case/blob/master/.docker/img/delivery.png">

<p>На странице выбора доставки, вам необходимо на основе записей в таблице delivery_service сформировать список доступных транспортных компаний. </p>
<p>Каждый элемент списка должен содержать в себе информацю об:</p>
<ul>
    <li>стоимости доставки;</li>
    <li>cроке доставки (например: от 1 до 5 д.).</li>
</ul>

<p>Данные о стоимости и сроках, можно получить из сервис-контейнера service-stub, который эмулирует ответ от внешнего апи.</p> 

##### Транспортная компания CDEK:

```php
    curl --location 'http://<укажите хост сервиса service-stub>/delivery/cdek' \
    --header 'Content-Type: application/json' \
    --data '{
        "username": "cdek-user-01", 
        "password": "123456789", 
        "weight": "5" 
    }'

    // Структура ответа:
    // Успешный ответ 
    {
        "status": true,
        "data": {
            "message": "OK",
            "price": "90",
            "delivery_from": "1",
            "delivery_to": "5"
        }
    }
    // Неуспешный ответ
    {
        "status": false,
        "data": {
            "message": "Неверный логин или пароль"
        }
    }
```

##### Транспортная компания FivePost:

```php

    curl --location 'http://<укажите хост сервиса service-stub>/delivery/fivepost' \
    --header 'apiKey: 448ed7416fce2cb66c2855d182b1ba3df1e90016d' \ 
    --header 'Content-Type: application/json' \
    --data '{
        "weight": "50"
    }'

    // Успешный ответ
    {
        "status": 200,
        "data": {
            "message": 200,
            "price": 50,
            "delivery_from": 5,
            "delivery_to": 24
        }
    }
    // Неуспешный ответ
    {
        "status": 403,
        "data": {
            "message": "Неверный apiKey"
        }
    }
```

<br />

### Страница выбора оплаты

URL: /checkout/payments/

> [!CAUTION]
> данная страница должна быть закрыта файерволом и недоступна для неавторизованного пользователя

> [!CAUTION]
> при заходе неавторизованного пользователя должен происходить редирект на главную страницу

> [!WARNING]
> не должно быть возможности напрямую зайти на эту страницу минуя страницу выбора доставки. поэтому, в случае, если пользователь заходит по прямой ссылке то должен сработать редирект на страницу "корзина". Подсказка: проверяйте заголовки refferer


<img src="https://github.com/vladpopov99/test-case/raw/master/.docker/img/payment.png">

<p>На странице выбора оплаты, вам необходимо по аналогии со страницей выбора доставки, вывести список платежных систем, которые доступны в приложении, и дать пользователю выбрать любую из них при помощи нажатия на кнопку "оплатить", после чего перевести пользователя на страницу успешной покупки.</p>

> [!WARNING]
> После того как пользователь нажал на кнопку "оплатить" следует зафиксировать состояние корзины, присвоив значение 1 в колонке ... . ... и создав новую запись о корзине для пользователя.

<br />

### Страница сообщения об успешной оплате

URL: /checkout/success-page/

<img src="https://github.com/vladpopov99/test-case/blob/master/.docker/img/success.png">

Страница на которой должна быть выведена зафиксированная информация о совершенном заказе: номер заказа (id), срок доставки и оплаченная сумма.
Так же на странице должна быть кнопка возвращения на главную страницу.